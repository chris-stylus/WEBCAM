<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESP32 Point & Shoot</title>
    
    <!-- React & Tailwind -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";

        // --- YOUR CREDENTIALS ---
        const firebaseConfig = {
            apiKey: "AIzaSyCx6BCyKA9FQ6cprrarImZKf9wHFBkJ7qs",
            authDomain: "web-cam-8ea0e.firebaseapp.com",
            databaseURL: "https://web-cam-8ea0e-default-rtdb.firebaseio.com",
            projectId: "web-cam-8ea0e",
            storageBucket: "web-cam-8ea0e.firebasestorage.app",
            messagingSenderId: "791818890690",
            appId: "1:791818890690:web:ce2bf048d6fcd721377a5b",
            measurementId: "G-W0YVZ7YDVY"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);
        
        // Expose to window for React
        window.db = db;
        window.auth = auth;
        window.firebaseRefs = { auth, ref, set, onValue, signInAnonymously, onAuthStateChanged };
    </script>
</head>
<body class="bg-gray-900 text-white font-sans">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        function App() {
            const [user, setUser] = useState(null);
            const [camIP, setCamIP] = useState(localStorage.getItem('camIP') || '');
            const [isFlashOn, setIsFlashOn] = useState(false);
            const [status, setStatus] = useState("Connecting to cloud...");
            const [streamUrl, setStreamUrl] = useState("");
            
            // Capture States
            const [isCapturing, setIsCapturing] = useState(false);
            const [capturedImage, setCapturedImage] = useState(null);

            useEffect(() => {
                const initInterval = setInterval(() => {
                    if (window.firebaseRefs) {
                        clearInterval(initInterval);
                        initializeFirebase();
                    }
                }, 100);
                return () => clearInterval(initInterval);
            }, []);

            const initializeFirebase = () => {
                const { auth, signInAnonymously, onAuthStateChanged } = window.firebaseRefs;

                if (!auth) return;

                const unsubscribe = onAuthStateChanged(auth, (u) => {
                    if (u) {
                        setUser(u);
                        setStatus("Cloud Connected");
                        setupListeners();
                    } else {
                        signInAnonymously(auth).catch((error) => {
                            console.error("Auth Failed", error);
                            setStatus("Auth Error");
                        });
                    }
                });
            };

            const setupListeners = () => {
                const { db, firebaseRefs } = window;
                if (!db || !firebaseRefs) return;

                const { ref, onValue } = firebaseRefs;
                const flashRef = ref(db, 'cctv/flash');
                onValue(flashRef, (snapshot) => {
                    setIsFlashOn(!!snapshot.val());
                });
            };

            const toggleFlash = () => {
                const { db, firebaseRefs } = window;
                const { ref, set } = firebaseRefs;
                set(ref(db, 'cctv/flash'), !isFlashOn);
            };

            const handleIpChange = (e) => {
                const ip = e.target.value;
                setCamIP(ip);
                localStorage.setItem('camIP', ip);
            };

            const startStream = () => {
                if(!camIP) return alert("Please enter IP Address");
                setStreamUrl(`http://${camIP}:80/stream`);
            };

            // --- NEW: CAPTURE LOGIC ---
            const handleCapture = async () => {
                if (!camIP) return alert("Connect to camera first");
                setIsCapturing(true);

                try {
                    // 1. Fetch from ESP32 /capture endpoint
                    const response = await fetch(`http://${camIP}/capture`);
                    if (!response.ok) throw new Error("Capture failed");
                    
                    // 2. Create blob URL
                    const blob = await response.blob();
                    const imageUrl = URL.createObjectURL(blob);
                    
                    // 3. Show Modal
                    setCapturedImage(imageUrl);
                } catch (error) {
                    alert("Capture Failed! Make sure:\n1. You are on the same WiFi\n2. If using GitHub Pages, allow 'Insecure Content' in browser settings.");
                    console.error(error);
                } finally {
                    setIsCapturing(false);
                }
            };

            const downloadImage = () => {
                const link = document.createElement('a');
                link.href = capturedImage;
                link.download = `esp32-snap-${Date.now()}.jpg`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };

            if (!user) {
                return (
                    <div className="h-screen flex items-center justify-center flex-col gap-4">
                        <div className="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-blue-500"></div>
                        <p className="text-gray-400 text-sm">{status}</p>
                    </div>
                );
            }

            return (
                <div className="min-h-screen max-w-md mx-auto bg-gray-800 shadow-2xl overflow-hidden md:max-w-2xl relative">
                    {/* Header */}
                    <div className="bg-blue-600 p-4 flex justify-between items-center shadow-lg z-10 relative">
                        <div className="flex items-center gap-3">
                            <i className="fa-solid fa-camera text-2xl"></i>
                            <h1 className="text-xl font-bold">Point & Shoot</h1>
                        </div>
                        <div className="flex items-center gap-2">
                            <span className="w-2 h-2 bg-green-400 rounded-full animate-pulse"></span>
                            <span className="text-xs font-mono opacity-80">{status}</span>
                        </div>
                    </div>

                    {/* Viewfinder */}
                    <div className="relative bg-black aspect-[4/3] flex items-center justify-center overflow-hidden group">
                        {streamUrl ? (
                            <img 
                                src={streamUrl} 
                                className="w-full h-full object-cover"
                                onError={(e) => console.log("Stream offline")}
                            />
                        ) : (
                            <div className="text-gray-500 flex flex-col items-center">
                                <i className="fa-solid fa-eye-slash text-4xl mb-2"></i>
                                <p>Stream Offline</p>
                            </div>
                        )}
                        
                        {/* Flash Effect Overlay */}
                        {isCapturing && (
                            <div className="absolute inset-0 bg-white animate-pulse z-20 opacity-90"></div>
                        )}
                    </div>

                    {/* Controls */}
                    <div className="p-6 space-y-6 pb-24">
                        
                        {/* Connection Bar */}
                        <div className="bg-gray-700/50 p-4 rounded-xl border border-gray-600">
                            <div className="flex gap-2">
                                <input 
                                    type="text" 
                                    value={camIP}
                                    onChange={handleIpChange}
                                    placeholder="Camera IP (e.g. 192.168.1.50)"
                                    className="flex-1 bg-gray-800 border-gray-600 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none"
                                />
                                <button onClick={startStream} className="bg-blue-500 text-white px-4 rounded-lg">
                                    <i className="fa-solid fa-link"></i>
                                </button>
                            </div>
                        </div>

                        {/* Big Buttons */}
                        <div className="grid grid-cols-2 gap-4">
                            <button 
                                onClick={toggleFlash}
                                className={`p-4 rounded-xl flex flex-col items-center gap-2 border ${
                                    isFlashOn 
                                    ? 'bg-yellow-500/20 border-yellow-500 text-yellow-500' 
                                    : 'bg-gray-700 border-gray-600 text-gray-400'
                                }`}
                            >
                                <i className="fa-solid fa-bolt text-2xl"></i>
                                <span className="font-medium">Torch</span>
                            </button>

                            <button 
                                onClick={handleCapture}
                                disabled={isCapturing}
                                className="p-4 rounded-xl flex flex-col items-center gap-2 bg-white text-gray-900 border border-white hover:bg-gray-200 transition-colors active:scale-95"
                            >
                                <i className="fa-solid fa-camera-retro text-2xl"></i>
                                <span className="font-bold">{isCapturing ? '...' : 'CAPTURE'}</span>
                            </button>
                        </div>
                    </div>

                    {/* Photo Preview Modal */}
                    {capturedImage && (
                        <div className="fixed inset-0 z-50 bg-black/90 flex items-center justify-center p-4 backdrop-blur-sm">
                            <div className="bg-gray-800 rounded-2xl max-w-lg w-full overflow-hidden shadow-2xl border border-gray-700">
                                <div className="p-4 border-b border-gray-700 flex justify-between items-center">
                                    <h3 className="font-bold">Captured Photo</h3>
                                    <button onClick={() => setCapturedImage(null)} className="text-gray-400 hover:text-white">
                                        <i className="fa-solid fa-xmark text-xl"></i>
                                    </button>
                                </div>
                                <div className="aspect-[4/3] bg-black">
                                    <img src={capturedImage} className="w-full h-full object-contain" />
                                </div>
                                <div className="p-4 flex gap-3">
                                    <button 
                                        onClick={downloadImage}
                                        className="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-xl font-bold flex items-center justify-center gap-2"
                                    >
                                        <i className="fa-solid fa-download"></i> Download
                                    </button>
                                    <button 
                                        onClick={() => setCapturedImage(null)}
                                        className="px-4 py-3 rounded-xl border border-gray-600 text-gray-300 hover:bg-gray-700"
                                    >
                                        Close
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
